Most recent batch
+-------------------+----------+--------------------+----------+-------------+------------------+--------+----+--------------+---+--------+--------------------+--------------+----------------+----------------+------------+-----+------------+----+--------+--------------+
|           Order_ID|order_Date|              Status|Fulfilment|Sales_Channel|ship_service_level|Category|Size|Courier_Status|Qty|currency|              Amount|     ship_city|      ship_state|ship_postal_code|ship_country|  B2B|fulfilled_by| New|PendingS|ingestion_date|
+-------------------+----------+--------------------+----------+-------------+------------------+--------+----+--------------+---+--------+--------------------+--------------+----------------+----------------+------------+-----+------------+----+--------+--------------+
|402-8288606-4313118|2022-01-04|             Shipped|    Amazon|    Amazon.in|         Expedited|   Shirt|   M|       Shipped|  1|     INR|   516.9989855015194|      BILASPUR|HIMACHAL PRADESH|          174001|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|405-3036350-8089120|2022-01-04|             Shipped|    Amazon|    Amazon.in|         Expedited|   Shirt|   M|       Shipped|  1|     INR|   794.9761527705574|     ANKLESHWR|         Gujarat|          393002|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|404-1580706-8406729|2022-01-04|             Shipped|    Amazon|    Amazon.in|         Expedited|   Shirt|  XL|       Shipped|  1|     INR|   474.9775639948803|       CHENNAI|      TAMIL NADU|          600028|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|404-4388660-6585119|2022-01-04|             Shipped|    Amazon|    Amazon.in|         Expedited| T-shirt|   L|       Shipped|  1|     INR|   1186.017084569087|     HYDERABAD|       TELANGANA|          500050|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|407-9815175-7715562|2022-01-04|           Cancelled|  Merchant|    Amazon.in|          Standard| T-shirt|   M|    On the Way|  0|     INR|   872.3500120399416|          UDMA|          KERALA|          671319|          IN|false|   Easy Ship|NULL|    NULL|    2024-08-24|
|171-4519721-7419566|2022-01-04|Shipped - Deliver...|  Merchant|    Amazon.in|          Standard| T-shirt|  XL|       Shipped|  1|     INR|   816.0325626263244|      GURUGRAM|         HARYANA|          122002|          IN|false|   Easy Ship|NULL|    NULL|    2024-08-24|
|408-2830412-5001168|2022-01-04|Shipped - Deliver...|  Merchant|    Amazon.in|          Standard|   Shirt|   M|       Shipped|  1|     INR|   499.0060075980319|        PUTTUR|       KARNATAKA|          574203|          IN|false|   Easy Ship|NULL|    NULL|    2024-08-24|
|406-2932330-3321959|2022-01-04|           Cancelled|    Amazon|    Amazon.in|         Expedited| T-shirt|   S|     Cancelled|  0|    NULL|                NULL|       CHIRAWA|       RAJASTHAN|          333026|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|403-3329838-9233131|2022-01-04|             Shipped|    Amazon|    Amazon.in|         Expedited| T-shirt|   M|       Shipped|  1|     INR|   653.9959868395791|       LUCKNOW|   UTTAR PRADESH|          226003|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|403-5061524-1069157|2022-01-04|             Shipped|    Amazon|    Amazon.in|         Expedited| T-shirt|  XS|       Shipped|  1|     INR|   1111.936616524575|        BHILAI|    CHHATTISGARH|          490006|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|407-2381438-0794755|2022-01-04|           Cancelled|  Merchant|    Amazon.in|          Standard| Blazzer| XXL|    On the Way|  0|     INR|   753.3861767860388|      GURUGRAM|         HARYANA|          122004|          IN|false|   Easy Ship|NULL|    NULL|    2024-08-24|
|407-9287244-6741956|2022-01-04|             Shipped|    Amazon|    Amazon.in|         Expedited| Blazzer|  XL|       Shipped|  1|     INR|   884.9918157660143|         SURAT|         Gujarat|          395009|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|402-6247468-4355542|2022-01-04|Shipped - Deliver...|  Merchant|    Amazon.in|          Standard|   Shirt|   L|       Shipped|  1|     INR|   458.9144711459592|     LAKHIMPUR|   UTTAR PRADESH|          262701|          IN|false|   Easy Ship|NULL|    NULL|    2024-08-24|
|404-8541183-2625124|2022-01-04|Shipped - Deliver...|  Merchant|    Amazon.in|          Standard| T-shirt|  XL|       Shipped|  1|     INR|   611.9737196812274|        GANJAM|          ODISHA|          761121|          IN|false|   Easy Ship|NULL|    NULL|    2024-08-24|
|408-2737126-0817167|2022-01-04|             Shipped|    Amazon|    Amazon.in|          Standard|   Shirt|   S|       Shipped| -1|     INR|-0.04737033896577508|     AHMEDABAD|         Gujarat|          382345|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|403-1147455-0953128|2022-01-04|             Shipped|    Amazon|    Amazon.in|         Expedited| T-shirt|   M|       Shipped|  1|     INR|  1648.0120845767817|        MUMBAI|     MAHARASHTRA|          400089|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|403-5256514-5961111|2022-01-04|           Cancelled|  Merchant|    Amazon.in|          Standard| T-shirt|   S|    On the Way|  0|    NULL|                NULL|        MUMBAI|     MAHARASHTRA|          400078|          IN|false|   Easy Ship|NULL|    NULL|    2024-08-24|
|405-4273004-7443538|2022-01-04|             Shipped|    Amazon|    Amazon.in|         Expedited|   Shirt|   L|       Shipped|  1|     INR|   353.0136606202708|        PILERU|  ANDHRA PRADESH|          517214|          IN|false|        NULL|NULL|    NULL|    2024-08-24|
|402-4715238-8520355|2022-01-04|           Cancelled|  Merchant|    Amazon.in|          Standard| T-shirt|   S|    On the Way|  0|     INR|  -681.0324080869824|SRI GANGANAGAR|       RAJASTHAN|          335001|          IN|false|   Easy Ship|NULL|    NULL|    2024-08-24|
|403-5332667-6713917|2022-01-04|           Cancelled|  Merchant|    Amazon.in|          Standard| T-shirt|   M|    On the Way|  0|     INR|   1278.622271690176|         BHOTA|HIMACHAL PRADESH|          176041|          IN|false|   Easy Ship|NULL|    NULL|    2024-08-24|
+-------------------+----------+--------------------+----------+-------------+------------------+--------+----+--------------+---+--------+--------------------+--------------+----------------+----------------+------------+-----+------------+----+--------+--------------+
only showing top 20 rows

STAGE 1: cleaned patch
source df: 26
stage1: cleaned_df: 16



STAGE2 query:
Create or replace a temporary table in Iceberg format with the cleaned data.
- Select columns from `cleaned_batch`, rounding 'Amount' values to 2 decimal places.
- Filter rows where column values match entries in corresponding reference tables.

 
    CREATE OR REPLACE TABLE nessie.db.silver_amazon_orders_temp
    USING ICEBERG AS
    SELECT
        src.Order_ID, src.order_Date, src.Status, src.Fulfilment, src.Sales_Channel, src.ship_service_level, src.Category, src.Size, src.Courier_Status, src.Qty, src.currency, ROUND(src.Amount, 2) AS Amount, src.ship_city, src.ship_state, src.ship_postal_code, src.ship_country, src.B2B, src.fulfilled_by, src.New, src.PendingS, src.ingestion_date
    FROM 
        cleaned_batch AS src
    WHERE
        src.Sales_Channel IN (
                SELECT 
                    Sales_Channel
                FROM
                    nessie.keys.Sales_Channel
            ) AND src.Status IN (
                SELECT 
                    Status
                FROM
                    nessie.keys.Status
            ) AND src.Category IN (
                SELECT 
                    Category
                FROM
                    nessie.keys.Category
            ) AND src.Fulfilment IN (
                SELECT 
                    Fulfilment
                FROM
                    nessie.keys.Fulfilment
            )
    


STAGE 2: cleaned patch
Source df: 26
Stage1: cleaned_df: 16
Stage2: cleaned_df: 16
INFO:py4j.clientserver:Closing down clientserver connection
